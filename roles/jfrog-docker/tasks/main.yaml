- name: Create Artifactory home directory
  file:
    path: "/ubuntu/home/jforg/artifactory/var/etc/"
    state: directory
    mode: "0755"
    owner: 1030
    group: 1030
    
- name: Create system.yaml file
  copy:
    content: |
      shared:
        database:
          driver: org.postgresql.Driver
          type: postgresql
          url: jdbc:postgresql://host.docker.internal:5432/artifactorydb
          username: artifactory
          password: password
    dest: "/ubuntu/home/jforg/artifactory/var/etc/system.yaml"
    owner: 1030
    group: 1030
    mode: "0644"
    
- name: Run PostgreSQL Docker container
  docker_container:
    name: artifactory-postgres
    image: postgres:latest
    state: started
    restart_policy: always
    env:
      POSTGRES_USER: artifactory
      POSTGRES_PASSWORD: password
      POSTGRES_DB: artifactorydb
    published_ports:
      - 5432:5432
      
- name: Run Artifactory Docker container
  docker_container:
    name: artifactory
    image: releases-docker.jfrog.io/jfrog/artifactory-pro:7.90.7
    state: started
    restart_policy: unless-stop
    volumes:
      - "/ubuntu/home/jforg/artifactory/var/:/var/opt/jfrog/artifactory"
    published_ports:
      - 8081:8081
      - 8082:8082
    env:  
      DB_TYPE: postgresql
      DB_HOST: artifactory-postgres
      POSTGRES_USER: artifactory
      POSTGRES_PASSWORD: password
      POSTGRES_DB: artifactorydb
